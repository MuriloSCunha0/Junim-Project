"""
Interface principal do JUNIM usando Streamlit
"""

import streamlit as st
import os
import tempfile
import logging
from datetime import datetime
from dotenv import load_dotenv

# Imports absolutos para evitar problemas de importa√ß√£o
import sys
from pathlib import Path

# Adiciona diret√≥rio pai ao path
current_dir = Path(__file__).parent
parent_dir = current_dir.parent
sys.path.append(str(parent_dir))

from core.pipeline import ModernizationPipeline
from utils.file_handler import FileHandler

# Import direto da interface de an√°lise
try:
    from ui.legacy_analysis_interface import render_legacy_analysis_interface
except ImportError:
    # Se falhar, criamos uma fun√ß√£o placeholder
    def render_legacy_analysis_interface():
        st.error("M√≥dulo de an√°lise n√£o dispon√≠vel. Verifique as depend√™ncias.")

# Configura√ß√£o do logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Carrega vari√°veis de ambiente
load_dotenv()

class JUNIMInterface:
    """Classe respons√°vel pela interface do usu√°rio do JUNIM"""
    
    def __init__(self):
        """Inicializa a interface"""
        self.file_handler = FileHandler()
        self.pipeline = None
        
    def run(self):
        """Executa a interface principal"""
        # Aplica CSS customizado
        add_custom_css()
        
        self._render_header()
        self._render_sidebar()
        self._render_main_content()
    
    def _render_header(self):
        """Renderiza o cabe√ßalho da aplica√ß√£o"""
        st.title("üöÄ JUNIM - Java Unified Interoperability Migration")
        st.markdown("""
        **Modernizador autom√°tico de sistemas Delphi para Java Spring Boot**
        
        Esta aplica√ß√£o utiliza IA generativa para converter projetos Delphi legados em aplica√ß√µes 
        Java Spring modernas, mantendo a l√≥gica de neg√≥cio e estrutura dos dados.
        """)
        
        st.divider()
    
    def _render_sidebar(self):
        """Renderiza a barra lateral com configura√ß√µes"""
        with st.sidebar:
            st.header("‚öôÔ∏è Configura√ß√µes")
            
            # Configura√ß√£o da API Groq
            st.subheader("API Groq")
            groq_api_key = st.text_input(
                "Chave da API Groq",
                type="password",
                value=os.getenv("GROQ_API_KEY", ""),
                help="Sua chave de API da Groq para acesso aos modelos LLM"
            )
            
            groq_model = st.selectbox(
                "Modelo Groq",
                ["llama3-70b-8192", "llama3-8b-8192", "mixtral-8x7b-32768"],
                index=0,
                help="Modelo da Groq a ser utilizado"
            )
            
            # Configura√ß√£o do Ollama (fallback)
            st.subheader("Ollama (Fallback)")
            ollama_url = st.text_input(
                "URL do Ollama",
                value=os.getenv("OLLAMA_URL", "http://localhost:11434"),
                help="URL da inst√¢ncia local do Ollama"
            )
            
            ollama_model = st.text_input(
                "Modelo Ollama",
                value=os.getenv("OLLAMA_DEFAULT_MODEL", "codellama:34b"),
                help="Modelo local do Ollama para fallback"
            )
            
            # Armazena configura√ß√µes na sess√£o
            st.session_state.config = {
                "groq_api_key": groq_api_key,
                "groq_model": groq_model,
                "ollama_url": ollama_url,
                "ollama_model": ollama_model
            }
            
            st.divider()
            
            # Informa√ß√µes do sistema
            st.subheader("‚ÑπÔ∏è Informa√ß√µes")
            st.info("""
            **Como usar:**
            1. Configure suas credenciais
            2. Fa√ßa upload do projeto Delphi (.zip)
            3. Clique em 'Modernizar'
            4. Baixe o projeto Java Spring
            """)
    
    def _render_main_content(self):
        """Renderiza o conte√∫do principal da interface"""
        
        # Navega√ß√£o por abas
        tab1, tab2, tab3 = st.tabs([
            "üîç An√°lise de Projeto Legado", 
            "üîÑ Moderniza√ß√£o Completa", 
            "üìä Dashboard"
        ])
        
        with tab1:
            # Nova funcionalidade de an√°lise detalhada
            render_legacy_analysis_interface()
        
        with tab2:
            # Funcionalidade original de moderniza√ß√£o
            self._render_modernization_interface()
        
        with tab3:
            # Dashboard de estat√≠sticas
            self._render_dashboard()
    
    def _render_modernization_interface(self):
        """Renderiza a interface de moderniza√ß√£o completa"""
        st.header("üîÑ Moderniza√ß√£o para Java Spring Boot")
        
        # Verifica se h√° projeto pr√©-carregado da an√°lise
        if self._has_analyzed_project():
            self._render_pre_loaded_project()
        else:
            self._render_upload_interface()
    
    def _has_analyzed_project(self):
        """Verifica se h√° um projeto analisado dispon√≠vel"""
        return (hasattr(st.session_state, 'analysis_results') and 
                st.session_state.analysis_results is not None and
                hasattr(st.session_state, 'generated_docs') and 
                st.session_state.generated_docs)
    
    def _render_pre_loaded_project(self):
        """Renderiza interface para projeto pr√©-carregado da an√°lise"""
        st.success("üéØ **Projeto pr√©-carregado da an√°lise!**")
        
        analysis = st.session_state.analysis_results
        docs = st.session_state.generated_docs
        
        # Informa√ß√µes do projeto analisado
        col1, col2, col3 = st.columns(3)
        
        with col1:
            project_name = analysis.get('metadata', {}).get('project_name', 'Projeto')
            st.metric("Projeto", project_name)
        
        with col2:
            units_count = len(analysis.get('units_analysis', {}))
            st.metric("Units Analisadas", units_count)
        
        with col3:
            docs_count = len(docs)
            st.metric("Documentos Gerados", docs_count)
        
        st.markdown("---")
        
        # Configura√ß√µes de moderniza√ß√£o
        self._render_modernization_settings()
        
        # Bot√£o de moderniza√ß√£o com documenta√ß√£o
        if st.button("üöÄ Modernizar com Documenta√ß√£o", type="primary", use_container_width=True):
            self._run_documentation_enhanced_modernization()
        
        st.markdown("---")
        
        # Op√ß√£o para carregar outro projeto
        with st.expander("üîÑ Carregar Projeto Diferente"):
            self._render_upload_interface(show_expander=False)
    
    def _render_upload_interface(self, show_expander=True):
        """Renderiza interface de upload de projeto"""
        col1, col2 = st.columns([2, 1])
        
        with col1:
            st.subheader("üìÅ Upload do Projeto Delphi")
            
            uploaded_file = st.file_uploader(
                "Selecione o arquivo .zip do projeto Delphi",
                type=["zip"],
                help="Fa√ßa upload de um arquivo .zip contendo todo o projeto Delphi (.pas, .dfm, etc.)"
            )
            
            if uploaded_file is not None:
                st.success(f"‚úÖ Arquivo carregado: {uploaded_file.name} ({uploaded_file.size} bytes)")
                
                # Configura√ß√µes de moderniza√ß√£o
                self._render_modernization_settings()
                
                # Bot√£o para iniciar moderniza√ß√£o
                if st.button("üîÑ Modernizar Projeto", type="primary", use_container_width=True):
                    self._run_modernization(uploaded_file)
        
        with col2:
            st.subheader("üìä Status")
            
            # Container para status em tempo real
            status_container = st.container()
            
            # Hist√≥rico de projetos (placeholder)
            if show_expander:
                with st.expander("üìà Estat√≠sticas"):
                    st.metric("Projetos Modernizados", "0", "0")
            else:
                st.metric("Projetos Modernizados", "0", "0")
    
    def _render_modernization_settings(self):
        """Renderiza configura√ß√µes da moderniza√ß√£o"""
        st.subheader("‚öôÔ∏è Configura√ß√µes da Moderniza√ß√£o")
        
        col1, col2 = st.columns(2)
        
        with col1:
            modernization_type = st.selectbox(
                "Tipo de Moderniza√ß√£o:",
                ["Convers√£o Completa", "Apenas Entidades", "Apenas APIs", "Apenas Servi√ßos"],
                help="Escolha o escopo da moderniza√ß√£o"
            )
            
            include_tests = st.checkbox(
                "Gerar Testes Unit√°rios",
                value=True,
                help="Inclui testes JUnit para o c√≥digo gerado"
            )
        
        with col2:
            use_specialized_prompts = st.checkbox(
                "Usar Prompts Especializados",
                value=True,
                help="Utiliza prompts otimizados para cada tipo de convers√£o"
            )
            
            generate_documentation = st.checkbox(
                "Gerar Documenta√ß√£o",
                value=True,
                help="Inclui documenta√ß√£o t√©cnica do c√≥digo Java"
            )
        
        # Armazena configura√ß√µes na sess√£o
        st.session_state.modernization_config = {
            'type': modernization_type,
            'include_tests': include_tests,
            'use_specialized_prompts': use_specialized_prompts,
            'generate_documentation': generate_documentation
        }
    
    def _run_documentation_enhanced_modernization(self):
        """Executa moderniza√ß√£o usando documenta√ß√£o gerada"""
        
        with st.spinner("üîÑ Iniciando moderniza√ß√£o com documenta√ß√£o..."):
            try:
                # Carrega configura√ß√µes
                config = getattr(st.session_state, 'modernization_config', {})
                
                # Inicializa pipeline com configura√ß√µes
                pipeline_config = st.session_state.config.copy()
                pipeline_config.update(config)
                self.pipeline = ModernizationPipeline(pipeline_config)
                
                # Importa PromptManager
                try:
                    from prompts.specialized_prompts import prompt_manager
                except ImportError:
                    # Fallback para prompts simples
                    from prompts.simple_loader import simple_prompt_loader as prompt_manager
                
                # Configura pipeline com dados de an√°lise
                self.pipeline.set_prompt_manager(prompt_manager)
                self.pipeline.set_analysis_data(
                    st.session_state.analysis_results,
                    st.session_state.generated_docs
                )
                
                # Progress bar
                progress_bar = st.progress(0)
                status_text = st.empty()
                
                # Callback para progresso
                def update_progress(step, total_steps, message):
                    progress = step / total_steps
                    progress_bar.progress(progress)
                    status_text.text(f"Passo {step}/{total_steps}: {message}")
                
                # Etapa 1: Prepara√ß√£o
                status_text.text("üìã Preparando moderniza√ß√£o...")
                progress_bar.progress(20)
                
                # Como n√£o temos projeto f√≠sico, simula moderniza√ß√£o baseada na documenta√ß√£o
                # Esta √© uma implementa√ß√£o de demonstra√ß√£o
                
                # Etapa 2: An√°lise com documenta√ß√£o
                status_text.text("üìñ Processando documenta√ß√£o...")
                progress_bar.progress(40)
                
                # Cria prompt enriquecido com documenta√ß√£o
                enhanced_prompt = prompt_manager.get_documentation_enhanced_prompt(
                    analysis_results=st.session_state.analysis_results,
                    generated_docs=st.session_state.generated_docs
                )
                
                # Etapa 3: Gera√ß√£o de c√≥digo (simulada)
                status_text.text("‚öôÔ∏è Gerando c√≥digo Java Spring...")
                progress_bar.progress(60)
                
                # Etapa 4: Aplica√ß√£o de prompts especializados
                if config.get('use_specialized_prompts', True):
                    status_text.text("üéØ Aplicando prompts especializados...")
                    progress_bar.progress(80)
                
                # Etapa 5: Finaliza√ß√£o
                status_text.text("‚úÖ Moderniza√ß√£o conclu√≠da!")
                progress_bar.progress(100)
                
                st.success("üéâ **Moderniza√ß√£o baseada em documenta√ß√£o conclu√≠da!**")
                st.info("üí° **Demo Mode**: Esta √© uma demonstra√ß√£o da funcionalidade. O c√≥digo Java seria gerado aqui.")
                
                # Mostra resumo do que seria gerado
                self._show_modernization_preview(enhanced_prompt)
                
                # Salva no hist√≥rico
                if 'modernization_history' not in st.session_state:
                    st.session_state.modernization_history = []
                
                st.session_state.modernization_history.append({
                    'timestamp': datetime.now().isoformat(),
                    'type': 'documentation_enhanced',
                    'config': config,
                    'project_name': st.session_state.analysis_results.get('metadata', {}).get('project_name', 'Unknown')
                })
                
            except Exception as e:
                st.error(f"‚ùå Erro durante moderniza√ß√£o: {str(e)}")
                logger.error(f"Erro na moderniza√ß√£o com documenta√ß√£o: {str(e)}")
    
    def _show_modernization_preview(self, enhanced_prompt: str):
        """Mostra preview do que seria gerado na moderniza√ß√£o"""
        
        st.subheader("üëÄ Preview da Moderniza√ß√£o")
        
        # Tabs para diferentes aspectos
        preview_tab1, preview_tab2, preview_tab3 = st.tabs([
            "üìù Prompt Gerado", 
            "üèóÔ∏è Estrutura Planejada", 
            "üìä M√©tricas"
        ])
        
        with preview_tab1:
            st.markdown("**Prompt enriquecido com documenta√ß√£o:**")
            st.text_area(
                "Prompt que seria usado para gerar o c√≥digo Java:",
                value=enhanced_prompt[:2000] + "..." if len(enhanced_prompt) > 2000 else enhanced_prompt,
                height=300,
                disabled=True
            )
        
        with preview_tab2:
            st.markdown("**Estrutura Java Spring que seria gerada:**")
            st.code("""
src/main/java/com/projeto/
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ DatabaseConfig.java
‚îÇ   ‚îî‚îÄ‚îÄ WebConfig.java
‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îú‚îÄ‚îÄ CustomerController.java
‚îÇ   ‚îî‚îÄ‚îÄ ProductController.java
‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îú‚îÄ‚îÄ CustomerService.java
‚îÇ   ‚îî‚îÄ‚îÄ ProductService.java
‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îú‚îÄ‚îÄ CustomerRepository.java
‚îÇ   ‚îî‚îÄ‚îÄ ProductRepository.java
‚îú‚îÄ‚îÄ entity/
‚îÇ   ‚îú‚îÄ‚îÄ Customer.java
‚îÇ   ‚îî‚îÄ‚îÄ Product.java
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ CustomerDTO.java
‚îÇ   ‚îî‚îÄ‚îÄ ProductDTO.java
‚îî‚îÄ‚îÄ exception/
    ‚îú‚îÄ‚îÄ GlobalExceptionHandler.java
    ‚îî‚îÄ‚îÄ BusinessException.java
            """, language="text")
        
        with preview_tab3:
            analysis = st.session_state.analysis_results
            
            col1, col2, col3 = st.columns(3)
            
            with col1:
                units_count = len(analysis.get('units_analysis', {}))
                estimated_classes = units_count * 2  # Estimativa
                st.metric("Classes Java Estimadas", estimated_classes)
            
            with col2:
                total_lines = sum(unit.get('lines_count', 0) for unit in analysis.get('units_analysis', {}).values())
                estimated_java_lines = int(total_lines * 1.3)  # Estimativa
                st.metric("Linhas Java Estimadas", f"{estimated_java_lines:,}")
            
            with col3:
                config = getattr(st.session_state, 'modernization_config', {})
                features = sum([
                    config.get('include_tests', False),
                    config.get('generate_documentation', False),
                    config.get('use_specialized_prompts', False)
                ])
                st.metric("Recursos Habilitados", features)
    
    def _render_dashboard(self):
        """Renderiza dashboard de estat√≠sticas e informa√ß√µes"""
        st.header("üìä Dashboard do JUNIM")
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            st.metric(
                label="üîç An√°lises Realizadas",
                value=len(getattr(st.session_state, 'analysis_history', [])),
                delta=None
            )
        
        with col2:
            st.metric(
                label="üîÑ Moderniza√ß√µes",
                value=len(getattr(st.session_state, 'modernization_history', [])),
                delta=None
            )
        
        with col3:
            st.metric(
                label="üìÑ Documentos Gerados",
                value=len(getattr(st.session_state, 'generated_docs', {})),
                delta=None
            )
        
        with col4:
            st.metric(
                label="‚öôÔ∏è Configura√ß√µes",
                value="OK" if hasattr(st.session_state, 'config') else "Pendente",
                delta=None
            )
        
        # Informa√ß√µes sobre o sistema
        st.subheader("‚ÑπÔ∏è Sobre o JUNIM")
        st.markdown("""
        ### Java Unified Interoperability Migration
        
        **JUNIM** √© uma ferramenta avan√ßada para moderniza√ß√£o de sistemas legados Delphi, 
        oferecendo an√°lise detalhada e migra√ß√£o autom√°tica para Java Spring Boot.
        
        #### üéØ Principais Funcionalidades:
        
        1. **üìã An√°lise Detalhada**: Extra√ß√£o de requisitos, funcionalidades e fluxos
        2. **üìù Documenta√ß√£o Autom√°tica**: Gera√ß√£o de documenta√ß√£o t√©cnica completa
        3. **üîó Mapeamento de Correla√ß√µes**: Delphi ‚Üí Java Spring equivalentes
        4. **üîÑ Moderniza√ß√£o Completa**: Convers√£o autom√°tica do c√≥digo
        5. **üìä M√©tricas de Qualidade**: An√°lise de complexidade e manutenibilidade
        
        #### üõ†Ô∏è Tecnologias Utilizadas:
        - **Python** com Streamlit para interface
        - **Groq API** para processamento IA de alto desempenho
        - **Ollama** para modelos locais como fallback
        - **Regex avan√ßado** para parsing de c√≥digo Delphi
        - **Templates Spring Boot** para gera√ß√£o de c√≥digo
        
        #### üìà Benef√≠cios:
        - ‚ö° **Rapidez**: An√°lise em minutos vs. semanas manuais
        - üéØ **Precis√£o**: Preserva√ß√£o da l√≥gica de neg√≥cio
        - üìö **Documenta√ß√£o**: Cria√ß√£o autom√°tica de documenta√ß√£o t√©cnica
        - üîÑ **Iterativo**: An√°lise antes da moderniza√ß√£o
        - üõ°Ô∏è **Confi√°vel**: M√∫ltiplas valida√ß√µes e verifica√ß√µes
        """)
        
        # Configura√ß√µes atuais
        if hasattr(st.session_state, 'config'):
            with st.expander("‚öôÔ∏è Configura√ß√µes Atuais"):
                config = st.session_state.config
                st.json({
                    "groq_model": config.get("groq_model", "N/A"),
                    "ollama_model": config.get("ollama_model", "N/A"),
                    "ollama_url": config.get("ollama_url", "N/A"),
                    "groq_configured": bool(config.get("groq_api_key", "")),
                })
        
        # Links √∫teis
        st.subheader("üîó Links √öteis")
        col1, col2, col3 = st.columns(3)
        
        with col1:
            st.markdown("""
            **üìö Documenta√ß√£o**
            - [Spring Boot Guide](https://spring.io/guides)
            - [Java Migration Best Practices](https://docs.oracle.com/javase/8/docs/)
            """)
        
        with col2:
            st.markdown("""
            **üõ†Ô∏è Ferramentas**
            - [Groq Console](https://console.groq.com/)
            - [Ollama Documentation](https://ollama.ai/docs)
            """)
        
        with col3:
            st.markdown("""
            **üéì Recursos**
            - [Delphi to Java Migration](https://example.com)
            - [Legacy System Modernization](https://example.com)
            """)
    
    
    def _run_modernization(self, uploaded_file):
        """Executa o pipeline de moderniza√ß√£o"""
        try:
            # Carrega configura√ß√µes da moderniza√ß√£o
            config = getattr(st.session_state, 'modernization_config', {})
            
            # Inicializa o pipeline com as configura√ß√µes
            pipeline_config = st.session_state.config.copy()
            pipeline_config.update(config)
            self.pipeline = ModernizationPipeline(pipeline_config)
            
            # Container para progresso
            progress_container = st.container()
            
            with progress_container:
                st.header("üîÑ Moderniza√ß√£o em Andamento")
                
                # Barra de progresso
                progress_bar = st.progress(0)
                status_text = st.empty()
                
                # Callback para atualizar progresso
                def update_progress(step, total_steps, message):
                    progress = step / total_steps
                    progress_bar.progress(progress)
                    status_text.text(f"Passo {step}/{total_steps}: {message}")
                
                # Cria arquivo tempor√°rio para o upload
                with tempfile.NamedTemporaryFile(delete=False, suffix='.zip') as tmp_file:
                    tmp_file.write(uploaded_file.getvalue())
                    temp_path = tmp_file.name
                
                try:
                    # Importa PromptManager se usar prompts especializados
                    if config.get('use_specialized_prompts', True):
                        try:
                            from prompts.specialized_prompts import prompt_manager
                            update_progress(1, 8, "Carregando prompts especializados...")
                            # Configura prompts no pipeline
                            self.pipeline.set_prompt_manager(prompt_manager)
                        except ImportError:
                            # Fallback para prompts simples
                            from prompts.simple_loader import simple_prompt_loader
                            update_progress(1, 8, "Carregando prompts simples...")
                            self.pipeline.set_prompt_manager(simple_prompt_loader)
                    
                    # Se h√° an√°lise pr√©via, carrega os dados
                    if self._has_analyzed_project():
                        update_progress(2, 8, "Carregando dados de an√°lise pr√©via...")
                        self.pipeline.set_analysis_data(
                            st.session_state.analysis_results,
                            st.session_state.generated_docs
                        )
                    
                    update_progress(3, 8, "Analisando projeto Delphi...")
                    
                    # Executa o pipeline
                    result_path = self.pipeline.run(
                        delphi_project_path=temp_path,
                        progress_callback=lambda s, t, m: update_progress(s + 3, 8, m)
                    )
                    
                    # Sucesso - oferece download
                    progress_bar.progress(1.0)
                    status_text.text("‚úÖ Moderniza√ß√£o conclu√≠da com sucesso!")
                    
                    st.success("üéâ Projeto modernizado com sucesso!")
                    
                    # Mostra estat√≠sticas da moderniza√ß√£o
                    self._show_modernization_stats()
                    
                    # Bot√£o de download
                    with open(result_path, 'rb') as file:
                        st.download_button(
                            label="üì• Baixar Projeto Java Spring",
                            data=file.read(),
                            file_name="modernized_project.zip",
                            mime="application/zip",
                            type="primary",
                            use_container_width=True
                        )
                    
                    # Limpa arquivo tempor√°rio
                    os.unlink(temp_path)
                    os.unlink(result_path)
                    
                except Exception as e:
                    st.error(f"‚ùå Erro durante a moderniza√ß√£o: {str(e)}")
                    status_text.text(f"‚ùå Erro: {str(e)}")
                    
                    # Limpa arquivo tempor√°rio
                    if os.path.exists(temp_path):
                        os.unlink(temp_path)
                    
        except Exception as e:
            st.error(f"‚ùå Erro ao inicializar pipeline: {str(e)}")
    
    def _render_footer(self):
        """Renderiza o rodap√© da aplica√ß√£o"""
        st.divider()
        st.markdown("""
        ---
        **JUNIM v1.0** - Desenvolvido como parte do TCC de Sistemas de Informa√ß√£o  
        *Powered by IA Generativa (Groq/Ollama) + RAG*
        """)

# Adiciona CSS customizado
def add_custom_css():
    """Adiciona estilos CSS customizados"""
    st.markdown("""
    <style>
    .main-header {
        background: linear-gradient(90deg, #1f4e79, #2d5aa0);
        padding: 1rem;
        border-radius: 10px;
        color: white;
        margin-bottom: 1rem;
    }
    
    .status-box {
        background: #f0f2f6;
        border-left: 5px solid #1f4e79;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
    }
    
    .success-box {
        background: #d4edda;
        border-left: 5px solid #28a745;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
    }
    
    .error-box {
        background: #f8d7da;
        border-left: 5px solid #dc3545;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
    }
    </style>
    """, unsafe_allow_html=True)

# N√£o aplica CSS na inicializa√ß√£o - ser√° aplicado na execu√ß√£o da interface
